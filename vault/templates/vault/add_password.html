{% extends "base.html" %}
{% load static %}

{% block title %}Add Password{% endblock %}
{% block content %}

<div class="add-password-container">
  <div class="form-card">
    <h2>Add New Password</h2>

    <form method="post" class="password-form">
      {% csrf_token %}

      <!-- Title and Category -->
      <div class="form-row">
        <div class="form-group">
          <label for="id_platform_name">Title *</label>
          {{ form.platform_name }}
        </div>
        <div class="form-group">
          <label for="id_category">Category *</label>
          {{ form.category }}
        </div>
      </div>

      <!-- Username -->
      <div class="form-group full-width">
        <label for="id_username">Username / Email</label>
        {{ form.username }}
      </div>

      <!-- Password -->
      <div class="form-group password-field">
        <label for="id_password_plain">Password *</label>
        <div class="password-input-wrapper">
          {{ form.password_plain }}
          <button type="button" class="icon-btn" id="togglePassword" title="Show/Hide Password">
            <span class="material-icons">visibility</span>
          </button>
          <button type="button" class="btn-generate" id="generatePassword">
            <span class="material-icons">auto_fix_high</span> Generate
          </button>
        </div>
        <div class="strength-bar">
          <div class="strength-fill" id="strengthFill"></div>
        </div>
        <span class="strength-text" id="strengthText">Strength: </span>
      </div>

      <!-- Website -->
      <div class="form-group full-width">
        <label for="id_url">Website URL</label>
        {{ form.url }}
      </div>

      <!-- Notes -->
      <div class="form-group full-width">
        <label for="id_notes">Notes</label>
        {{ form.notes }}
      </div>

      <!-- Buttons -->
      <div class="form-actions">
        <button type="submit" class="btn primary">Save Password</button>
        <a href="{% url 'vault:list_passwords' %}" class="btn secondary">Cancel</a>
      </div>
    </form>
  </div>
</div>

<script>
  // Toggle password visibility
  const togglePassword = document.getElementById('togglePassword');
  const passwordField = document.getElementById('id_password_plain');
  togglePassword.addEventListener('click', () => {
    const type = passwordField.type === 'password' ? 'text' : 'password';
    passwordField.type = type;
  });

  // Generate password
  const generatePassword = document.getElementById('generatePassword');
  generatePassword.addEventListener('click', () => {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789@#$%&*!";
    let pwd = "";
    for (let i = 0; i < 12; i++) pwd += chars.charAt(Math.floor(Math.random() * chars.length));
    passwordField.value = pwd;
    checkStrength(pwd);
  });

  // Strength bar logic
  const strengthFill = document.getElementById('strengthFill');
  const strengthText = document.getElementById('strengthText');

  passwordField.addEventListener('input', (e) => {
    checkStrength(e.target.value);
  });

  function checkStrength(password) {
    let strength = 0;
    if (password.length > 7) strength += 1;
    if (password.match(/[A-Z]/)) strength += 1;
    if (password.match(/[0-9]/)) strength += 1;
    if (password.match(/[@#$%&*!]/)) strength += 1;

    const colors = ["#d9534f", "#f0ad4e", "#5bc0de", "#5cb85c"];
    const texts = ["Weak", "Fair", "Good", "Strong"];
    const width = ["25%", "50%", "75%", "100%"];

    strengthFill.style.width = width[strength - 1] || "10%";
    strengthFill.style.background = colors[strength - 1] || "#ccc";
    strengthText.textContent = strength ? `Strength: ${texts[strength - 1]}` : "Strength:";
  }
</script>

{% endblock %}
